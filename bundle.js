(()=>{"use strict";(()=>{const e={isEnter:e=>"Enter"===e.key,isEscape:e=>"Escape"===e.key};let t;window.util={escapePressHandler:t=>{e.isEscape(t)&&window.page.closePopup()},buttonClickHandler:()=>{window.page.closePopup()},Keys:e,debounce:e=>{t&&clearTimeout(t),t=setTimeout(e,500)},chooseFile:(e,t,o=!0)=>{const r=["gif","jpg","jpeg","png"];if(e.files.length){const n=e.files[0],s=n.name.toLowerCase();if(r.some((e=>s.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{if(o)t.src=e.result;else{const o=document.createElement("img");o.src=e.result,o.width=t.offsetWidth,o.height=t.offsetHeight,t.appendChild(o)}})),e.readAsDataURL(n)}}}}})(),(()=>{const e=document.querySelector(".map__filters");window.filter={filteredDataArray:t=>{const o={type:e.querySelector("#housing-type").value,price:e.querySelector("#housing-price").value,rooms:e.querySelector("#housing-rooms").value,guests:e.querySelector("#housing-guests").value,features:Array.from(e.querySelectorAll(".map__checkbox:checked")).map((e=>e.value))};let r=[];for(let e=0;e<t.length;e++){let n=!0;switch(n){case t[e].offer.type!==o.type&&"any"!==o.type:case t[e].offer.rooms!==Number(o.rooms)&&"any"!==o.rooms:case t[e].offer.guests!==Number(o.guests)&&"any"!==o.guests:case t[e].offer.price>=1e4&&"low"===o.price:case t[e].offer.price<=5e4&&"high"===o.price:case(t[e].offer.price<1e4||t[e].offer.price>5e4)&&"middle"===o.price:n=!1;break;case t[e].offer.features!==o.features&&0!==o.features.length:o.features.forEach((o=>{t[e].offer.features.includes(o)||(n=!1)}))}if(!0===n&&r.push(t[e]),5===r.length)break}return r}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking";window.loadData=(t,o)=>{const r=new XMLHttpRequest;r.responseType="json",r.open("GET",e),r.addEventListener("load",(()=>{200===r.status?t(r.response):o(`Статус ответа ${r.status}. ${r.statusText}`)})),r.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за  ${r.timeout} мс`)})),r.timeout=1e4,r.send()},window.upload=(e,o,r)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{o(n.response)})),n.open("POST",t),n.send(e),n.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за  ${n.timeout} мс`)})),n.timeout=1e4}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pins={renderPin:t=>{const o=e.cloneNode(!0),r=t.location,n=r.x-25,s=r.y-70,c=t.author,i=t.offer;return o.style=`left: ${n}px; top: ${s}px;`,o.querySelector("img").src=""+c.avatar,o.querySelector("img").alt=""+i.title,o}}})(),window.card={renderCard:e=>{const t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),o=t.querySelector(".popup__photos"),r=t.querySelector(".popup__features"),n=e.offer,s=e.author,c=n.features,i=n.photos;t.querySelector(".popup__title").textContent=""+n.title,t.querySelector(".popup__text--address").textContent=""+n.address,t.querySelector(".popup__text--price").textContent=n.price+"₽/ночь",t.querySelector(".popup__type").textContent=window.form.TYPES[n.type][name],t.querySelector(".popup__text--capacity").textContent=`${n.rooms} комнаты для ${n.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${n.checkin}, выезд до ${n.checkout}`,r.innerHTML="";for(let e=0;e<c.length;e++){const t=document.createElement("li");t.className="popup__feature popup__feature--"+n.features[e],r.appendChild(t)}t.querySelector(".popup__description").textContent=""+n.description,o.innerHTML="";for(let e=0;e<i.length;e++){const t=document.createElement("img");t.className="popup__photo",t.src=""+i[e],t.alt=""+n.title,t.width="45",t.height="40",o.appendChild(t)}return t.querySelector(".popup__avatar").src=""+s.avatar,t}},(()=>{const e=document.querySelector(".ad-form"),t=(t,o,n)=>{let s=r.offsetHeight/2;n&&(s=r.offsetHeight),e.querySelector("#address").value=`${Math.round(o+r.offsetWidth/2)}, ${Math.round(t+s)}`},o=document.querySelector(".map"),r=o.querySelector(".map__pin--main");r.addEventListener("mousedown",(e=>{e.preventDefault();let n={x:e.clientX,y:e.clientY},s=!1;const c=e=>{e.preventDefault(),s=!0;let c=n.x-e.clientX,i=n.y-e.clientY;n={x:e.clientX,y:e.clientY};let a=r.offsetLeft-c,d=r.offsetTop-i;a<0?a=0:a>o.offsetWidth-r.offsetWidth&&(a=o.offsetWidth-r.offsetWidth),d<130?d=130:d>630&&(d=630),r.style.left=a+"px",r.style.top=d+"px",t(d,a,!0)},i=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",i),s){const e=t=>{t.preventDefault(),r.removeEventListener("click",e)};r.addEventListener("click",e)}};document.addEventListener("mousemove",c),document.addEventListener("mouseup",i)})),window.move={fillAddressValue:t}})(),(()=>{let e=[];const t=document.querySelector(".map"),o=document.querySelector(".map__pins"),r=document.createDocumentFragment(),n=document.querySelector(".map__filters-container"),s=document.querySelector(".map__filters"),c=e=>{document.querySelector(".popup")&&u();const o=window.card.renderCard(e);t.insertBefore(o,n),t.querySelector(".popup__close").addEventListener("click",window.util.buttonClickHandler),document.addEventListener("keydown",window.util.escapePressHandler)},i=e=>{let t=window.filter.filteredDataArray(e),n=5;t.length<5&&(n=t.length),t=t.slice(0,n),t.forEach((e=>{const t=window.pins.renderPin(e);r.appendChild(t),t.addEventListener("click",(()=>{c(e)})),t.addEventListener("keydown",(t=>{window.util.Keys.isEnter(t)&&c(e)}))})),o.appendChild(r)},a=t=>{e=t;const o=t.length>5?t.slice(0,5):t;i(o)},d=e=>{const t=document.createElement("div");t.style="z-index: 100; color: wheat;",t.style.fontSize="30px",t.classList.add("error"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},l=()=>{const e=t.querySelector(".popup");e&&t.removeChild(e)},u=()=>{document.removeEventListener("keydown",window.util.escapePressHandler),t.querySelector(".popup__close").removeEventListener("click",window.util.buttonClickHandler),l()};s.addEventListener("change",(()=>{window.util.debounce((()=>i(e))),window.form.removePins(),l()})),window.page={showPins:()=>{window.loadData(a,d)},removeCard:l,dataArray:e,successHandler:a,updatePins:i,closePopup:u}})(),(()=>{const e={house:{name:"дом",minprice:5e3},flat:{name:"квартира",minprice:1e3},palace:{name:"дворец",minprice:1e4},bungalow:{name:"бунгало",minprice:0}},t={1:[1],2:[1,2],3:[1,2,3],100:[0]},o=document.querySelector(".map"),r=o.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),s=document.querySelector(".map__filters-container"),c=n.querySelectorAll("fieldset"),i=s.querySelectorAll("select"),a=s.querySelectorAll(".map__checkbox"),d=n.querySelector("#price"),l=n.querySelector("#type"),u=n.querySelector("#timeout"),p=n.querySelector("#timein"),m=n.querySelector("#room_number"),f=n.querySelector("#capacity"),y=n.querySelector(".ad-form__reset"),v=n.querySelector(".ad-form__field input[type=file]"),w=n.querySelector(".ad-form-header__preview img"),h=w.src,E=n.querySelector(".ad-form__upload input[type=file]"),S=n.querySelector(".ad-form__photo"),_=()=>{window.util.chooseFile(v,w)},q=()=>{window.util.chooseFile(E,S,!1)},g={y:r.offsetTop,x:r.offsetLeft};window.move.fillAddressValue(g.x,g.y,!1),d.placeholder=e[l.value].minprice,d.min=e[l.value].minprice;const L=(e,t)=>{t.value=e.value},k=()=>{f.value=t[m.value][0],f.querySelectorAll("option").forEach((e=>{e.disabled=!t[m.value].includes(Number(e.value))}))};f.value=t[m.value][0],k();const b=()=>{const e=o.querySelectorAll(".map__pin:not(:first-of-type)");for(let t=0;t<e.length;t++)e[t].remove()},x=()=>{o.classList.add("map--faded"),n.classList.add("ad-form--disabled"),f.value=t[m.value][0],k(),window.move.fillAddressValue(g.x,g.y,!1),r.style.left=g.x+"px",r.style.top=g.y+"px",c.forEach((e=>{e.disabled=!0})),i.forEach((e=>{e.disabled=!0,e.selectedIndex=0})),a.forEach((e=>{e.checked=!1,e.disabled=!0})),b(),document.querySelector(".popup")&&window.page.closePopup(),v.removeEventListener("change",_),E.removeEventListener("change",q),S.innerHTML="",w.src=h},A=()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e);const t=document.querySelector(".error"),o=e=>{window.util.Keys.isEscape(e)&&(document.removeEventListener("keydown",o),t.remove())};document.addEventListener("keydown",o);const r=()=>{t.removeEventListener("click",r),t.remove()};t.addEventListener("click",r)},C=()=>{n.reset(),x(),b();const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e);const t=document.querySelector(".success"),o=e=>{window.util.Keys.isEscape(e)&&(document.removeEventListener("keydown",o),t.remove())};document.addEventListener("keydown",o);const r=()=>{t.removeEventListener("click",r),t.remove()};t.addEventListener("click",r)};l.addEventListener("input",(()=>{d.min=e[l.value].minprice,d.placeholder=e[l.value].minprice})),p.addEventListener("input",(()=>{L(p,u)})),u.addEventListener("input",(()=>{L(u,p)})),m.addEventListener("input",(()=>{k()})),window.form={TYPES:e,formActivateHandler:()=>{window.move.fillAddressValue(g.x,g.y,!0),o.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),c.forEach((e=>{e.disabled=!1})),i.forEach((e=>{e.disabled=!1})),a.forEach((e=>{e.disabled=!1})),window.page.showPins(),n.addEventListener("submit",(e=>{window.upload(new FormData(n),C,A),e.preventDefault()})),v.addEventListener("change",_),E.addEventListener("change",q),y.addEventListener("click",x)},formDeactivateHandler:x,removePins:b}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pin--main");window.form.formDeactivateHandler(),e.addEventListener("mousedown",(e=>{0===e.button&&window.form.formActivateHandler()})),e.addEventListener("keydown",(e=>{window.page.Keys.isEnter(e)&&window.form.formActivateHandler()}))})()})();
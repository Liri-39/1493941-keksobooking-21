(()=>{"use strict";(()=>{const e={isEnter:e=>"Enter"===e.key,isEscape:e=>"Escape"===e.key};let t;window.util={escapePressHandler:function(t){e.isEscape(t)&&window.page.closePopup()},buttonClickHandler:function(){window.page.closePopup()},Keys:e,debounce:function(e){t&&clearTimeout(t),t=setTimeout(e,500)}}})(),(()=>{const e=document.querySelector(".map__filters");window.filter={filteredDataArray:t=>{const n={type:e.querySelector("#housing-type").value,price:e.querySelector("#housing-price").value,rooms:e.querySelector("#housing-rooms").value,guests:e.querySelector("#housing-guests").value,features:Array.from(e.querySelectorAll(".map__checkbox:checked")).map((e=>e.value))};let o=[];for(let e=0;e<t.length;e++){let r=!0;switch(r){case t[e].offer.type!==n.type&&"any"!==n.type:case t[e].offer.rooms!==Number(n.rooms)&&"any"!==n.rooms:case t[e].offer.guests!==Number(n.guests)&&"any"!==n.guests:case t[e].offer.price>=1e4&&"low"===n.price:case t[e].offer.price<=5e4&&"high"===n.price:case(t[e].offer.price<1e4||t[e].offer.price>5e4)&&"middle"===n.price:r=!1;break;case t[e].offer.features!==n.features&&0!==n.features.length:n.features.forEach((n=>{t[e].offer.features.includes(n)||(r=!1)}))}if(!0===r&&o.push(t[e]),5===o.length)break}return o}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking";window.loadData=function(t,n){const o=new XMLHttpRequest;o.responseType="json",o.open("GET",e),o.addEventListener("load",(function(){200===o.status?t(o.response):n(`Статус ответа ${o.status}. ${o.statusText}`)})),o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за  ${o.timeout} мс`)})),o.timeout=1e4,o.send()},window.upload=function(e,n,o){const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(function(){n(r.response)})),r.open("POST",t),r.send(e),r.addEventListener("error",(function(){o("Произошла ошибка соединения")})),r.addEventListener("timeout",(function(){o(`Запрос не успел выполниться за  ${r.timeout} мс`)})),r.timeout=1e4}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pins={renderPin:function(t){const n=e.cloneNode(!0),o=t.location,r=o.x-25,c=o.y-70,i=t.author,u=t.offer;return n.style=`left: ${r}px; top: ${c}px;`,n.querySelector("img").src=""+i.avatar,n.querySelector("img").alt=""+u.title,n}}})(),window.card={renderCard:function(e){const t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),n=t.querySelector(".popup__photos"),o=t.querySelector(".popup__features"),r=e.offer,c=e.author,i=r.features,u=r.photos;t.querySelector(".popup__title").textContent=""+r.title,t.querySelector(".popup__text--address").textContent=""+r.address,t.querySelector(".popup__text--price").textContent=r.price+"₽/ночь",t.querySelector(".popup__type").textContent=window.form.TYPES[r.type][name],t.querySelector(".popup__text--capacity").textContent=`${r.rooms} комнаты для ${r.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${r.checkin}, выезд до ${r.checkout}`,o.innerHTML="";for(let e=0;e<i.length;e++){const t=document.createElement("li");t.className="popup__feature popup__feature--"+r.features[e],o.appendChild(t)}t.querySelector(".popup__description").textContent=""+r.description,n.innerHTML="";for(let e=0;e<u.length;e++){const t=document.createElement("img");t.className="popup__photo",t.src=""+u[e],t.alt=""+r.title,t.width="45",t.height="40",n.appendChild(t)}return t.querySelector(".popup__avatar").src=""+c.avatar,t}},(()=>{const e=document.querySelector(".ad-form"),t=function(t,n,r){let c=o.offsetHeight/2;r&&(c=o.offsetHeight),e.querySelector("#address").value=`${Math.round(n+o.offsetWidth/2)}, ${Math.round(t+c)}`},n=document.querySelector(".map"),o=n.querySelector(".map__pin--main");o.addEventListener("mousedown",(function(e){e.preventDefault();let r={x:e.clientX,y:e.clientY},c=!1;const i=function(e){e.preventDefault(),c=!0;let i=r.x-e.clientX,u=r.y-e.clientY;r={x:e.clientX,y:e.clientY};let s=o.offsetLeft-i,a=o.offsetTop-u;s<0?s=0:s>n.offsetWidth-o.offsetWidth&&(s=n.offsetWidth-o.offsetWidth),a<130?a=130:a>630&&(a=630),o.style.left=s+"px",o.style.top=a+"px",t(a,s,!0)},u=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",u),c){const e=function(t){t.preventDefault(),o.removeEventListener("click",e)};o.addEventListener("click",e)}};document.addEventListener("mousemove",i),document.addEventListener("mouseup",u)})),window.move={fillAddressValue:t}})(),(()=>{let e=[];const t=document.querySelector(".map"),n=document.querySelector(".map__pins"),o=document.createDocumentFragment(),r=document.querySelector(".map__filters-container"),c=document.querySelector(".map__filters"),i=function(e){document.querySelector(".popup")&&l();const n=window.card.renderCard(e);t.insertBefore(n,r),t.querySelector(".popup__close").addEventListener("click",window.util.buttonClickHandler),document.addEventListener("keydown",window.util.escapePressHandler)},u=e=>{let t=window.filter.filteredDataArray(e),r=5;t.length<5&&(r=t.length),t=t.slice(0,r),t.forEach((e=>{const t=window.pins.renderPin(e);o.appendChild(t),t.addEventListener("click",(function(){i(e)})),t.addEventListener("keydown",(function(t){window.util.Keys.isEnter(t)&&i(e)}))})),n.appendChild(o)},s=function(t){e=t;const n=t.length>5?t.slice(0,5):t;u(n)},a=function(e){const t=document.createElement("div");t.style="z-index: 100; color: wheat;",t.style.fontSize="30px",t.classList.add("error"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},d=()=>{const e=t.querySelector(".popup");e&&t.removeChild(e)},l=function(){document.removeEventListener("keydown",window.util.escapePressHandler),t.querySelector(".popup__close").removeEventListener("click",window.util.buttonClickHandler),d()};c.addEventListener("change",(function(){window.util.debounce((()=>u(e))),window.form.removePins(),d()})),window.page={showPins:function(){window.loadData(s,a)},removeCard:d,dataArray:e,successHandler:s,updatePins:u,closePopup:l}})(),(()=>{const e={house:{name:"дом",minprice:5e3},flat:{name:"квартира",minprice:1e3},palace:{name:"дворец",minprice:1e4},bungalow:{name:"бунгало",minprice:0}},t={1:[1],2:[1,2],3:[1,2,3],100:[0]},n=document.querySelector(".map"),o=n.querySelector(".map__pin--main"),r=document.querySelector(".ad-form"),c=document.querySelector(".map__filters-container"),i=r.querySelectorAll("fieldset"),u=c.querySelectorAll("select"),s=c.querySelectorAll(".map__checkbox"),a=r.querySelector("#price"),d=r.querySelector("#type"),l=r.querySelector("#timeout"),p=r.querySelector("#timein"),f=r.querySelector("#room_number"),m=r.querySelector("#capacity"),y=document.querySelector(".ad-form__reset"),v={y:o.offsetTop,x:o.offsetLeft};window.move.fillAddressValue(v.x,v.y,!1),a.placeholder=e[d.value].minprice,a.min=e[d.value].minprice;const w=function(e,t){t.value=e.value},h=function(){m.value=t[f.value][0],m.querySelectorAll("option").forEach((function(e){e.disabled=!t[f.value].includes(Number(e.value))}))};m.value=t[f.value][0],h();const E=()=>{const e=n.querySelectorAll(".map__pin:not(:first-of-type)");for(let t=0;t<e.length;t++)e[t].remove()},S=function(){n.classList.add("map--faded"),r.classList.add("ad-form--disabled"),m.value=t[f.value][0],h(),window.move.fillAddressValue(v.x,v.y,!1),o.style.left=v.x+"px",o.style.top=v.y+"px",i.forEach((function(e){e.disabled=!0})),u.forEach((function(e){e.disabled=!0})),s.forEach((function(e){e.checked=!1,e.disabled=!0})),E(),document.querySelector(".popup")&&window.page.closePopup()};y.addEventListener("click",S);const q=function(){const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e);const t=document.querySelector(".error"),n=function(e){window.util.Keys.isEscape(e)&&(document.removeEventListener("keydown",n),t.remove())};document.addEventListener("keydown",n);const o=function(){t.removeEventListener("click",o),t.remove()};t.addEventListener("click",o)},_=function(){r.reset(),S(),E();const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e);const t=document.querySelector(".success"),n=function(e){window.util.Keys.isEscape(e)&&(document.removeEventListener("keydown",n),t.remove())};document.addEventListener("keydown",n);const o=function(){t.removeEventListener("click",o),t.remove()};t.addEventListener("click",o)};d.addEventListener("input",(function(){a.min=e[d.value].minprice,a.placeholder=e[d.value].minprice})),p.addEventListener("input",(function(){w(p,l)})),l.addEventListener("input",(function(){w(l,p)})),f.addEventListener("input",(function(){h()})),window.form={TYPES:e,formActivateHandler:function(){window.move.fillAddressValue(v.x,v.y,!0),n.classList.remove("map--faded"),r.classList.remove("ad-form--disabled"),i.forEach((function(e){e.disabled=!1})),u.forEach((function(e){e.disabled=!1})),s.forEach((function(e){e.disabled=!1})),window.page.showPins(),r.addEventListener("submit",(function(e){window.upload(new FormData(r),_,q),e.preventDefault()}))},formDeactivateHandler:S,removePins:E}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pin--main");window.form.formDeactivateHandler(),e.addEventListener("mousedown",(function(e){0===e.button&&window.form.formActivateHandler()})),e.addEventListener("keydown",(function(e){window.page.Keys.isEnter(e)&&window.form.formActivateHandler()}))})()})();
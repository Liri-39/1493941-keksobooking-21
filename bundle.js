(()=>{"use strict";(()=>{const e={isEnter:e=>"Enter"===e.key,isEscape:e=>"Escape"===e.key};let t;window.util={escapePressHandler:t=>{e.isEscape(t)&&window.page.closePopup()},buttonClickHandler:()=>{window.page.closePopup()},Keys:e,debounce:e=>{t&&clearTimeout(t),t=setTimeout(e,500)},chooseFile:(e,t,o=!0)=>{const r=["gif","jpg","jpeg","png"];if(e.files.length){const n=e.files[0],i=n.name.toLowerCase();if(r.some((e=>i.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{if(o)t.src=e.result;else{const o=document.createElement("img");o.src=e.result,o.width=t.offsetWidth,o.height=t.offsetHeight,t.appendChild(o)}})),e.readAsDataURL(n)}}},removeElement:(t,o,r)=>{"keydown"===t.type?e.isEscape(t)&&document.removeEventListener("keydown",r):"click"===t.type&&document.removeEventListener("click",r),o.remove()}}})(),(()=>{const e=document.querySelector(".map__filters");window.filter={getfilteredDataArray:t=>{const o={type:e.querySelector("#housing-type").value,price:e.querySelector("#housing-price").value,rooms:e.querySelector("#housing-rooms").value,guests:e.querySelector("#housing-guests").value,features:Array.from(e.querySelectorAll(".map__checkbox:checked")).map((e=>e.value))};let r=[];for(let e=0;e<t.length;e++){let n=!0;switch(n){case t[e].offer.type!==o.type&&"any"!==o.type:case t[e].offer.rooms!==Number(o.rooms)&&"any"!==o.rooms:case t[e].offer.guests!==Number(o.guests)&&"any"!==o.guests:case t[e].offer.price>=1e4&&"low"===o.price:case t[e].offer.price<=5e4&&"high"===o.price:case(t[e].offer.price<1e4||t[e].offer.price>5e4)&&"middle"===o.price:n=!1;break;case t[e].offer.features!==o.features&&0!==o.features.length:o.features.forEach((o=>{t[e].offer.features.includes(o)||(n=!1)}))}if(!0===n&&r.push(t[e]),5===r.length)break}return r},MAX_SIMILAR_PINS_COUNT:5}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking";window.load=(o,r,n)=>{const i=new XMLHttpRequest;i.responseType="json",n?(i.open("POST",t),i.addEventListener("load",(()=>{o(i.response)})),i.send(n)):(i.open("GET",e),i.addEventListener("load",(()=>{200===i.status?o(i.response):r(`Статус ответа ${i.status}. ${i.statusText}`)})),i.send()),i.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за  ${i.timeout} мс`)})),i.timeout=1e4}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pins={renderElement:t=>{const o=e.cloneNode(!0),r=t.location,n=r.x-25,i=r.y-70,c=t.author,s=t.offer;return o.style=`left: ${n}px; top: ${i}px;`,o.querySelector("img").src=""+c.avatar,o.querySelector("img").alt=""+s.title,o}}})(),window.card={renderElement:e=>{const t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),o=t.querySelector(".popup__photos"),r=t.querySelector(".popup__features"),n=e.offer,i=e.author,c=n.features,s=n.photos;t.querySelector(".popup__title").textContent=""+n.title,t.querySelector(".popup__text--address").textContent=""+n.address,t.querySelector(".popup__text--price").textContent=n.price+"₽/ночь",t.querySelector(".popup__type").textContent=window.form.TYPES[n.type][name],t.querySelector(".popup__text--capacity").textContent=`${n.rooms} комнаты для ${n.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${n.checkin}, выезд до ${n.checkout}`,r.innerHTML="";for(let e=0;e<c.length;e++){const t=document.createElement("li");t.className="popup__feature popup__feature--"+n.features[e],r.appendChild(t)}t.querySelector(".popup__description").textContent=""+n.description,o.innerHTML="";for(let e=0;e<s.length;e++){const t=document.createElement("img");t.className="popup__photo",t.src=""+s[e],t.alt=""+n.title,t.width="45",t.height="40",o.appendChild(t)}return t.querySelector(".popup__avatar").src=""+i.avatar,t}},(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=22,r=document.querySelector(".ad-form"),n=(e,n,i)=>{let c=t.offsetHeight/2;const s=t.offsetWidth/2;i&&(c=t.offsetHeight+o),r.querySelector("#address").value=`${Math.round(e+s)}, ${Math.round(n+c)}`};t.addEventListener("mousedown",(r=>{r.preventDefault();let i={x:r.clientX,y:r.clientY},c=!1;const s=r=>{r.preventDefault(),c=!0;let s=i.x-r.clientX,d=i.y-r.clientY;i={x:r.clientX,y:r.clientY};let l=t.offsetLeft-s,a=t.offsetTop-d;a<130-t.offsetHeight-o?a=130-t.offsetHeight-o:a>630-t.offsetHeight-o&&(a=630-t.offsetHeight-o),l<0-t.offsetWidth/2?l=0-t.offsetWidth/2:l>e.offsetWidth-t.offsetWidth/2&&(l=e.offsetWidth-t.offsetWidth/2),t.style.left=l+"px",t.style.top=a+"px",n(l,a,!0)},d=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d),c){const e=o=>{o.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}};document.addEventListener("mousemove",s),document.addEventListener("mouseup",d)})),window.move={fillAddressValue:n,PIN_TAIL:o}})(),(()=>{let e=[];const t=document.querySelector(".map"),o=document.querySelector(".map__pins"),r=document.createDocumentFragment(),n=document.querySelector(".map__filters-container"),i=document.querySelector(".map__filters"),c=e=>{document.querySelector(".popup")&&u();const o=window.card.renderElement(e);t.insertBefore(o,n),t.querySelector(".popup__close").addEventListener("click",window.util.buttonClickHandler),document.addEventListener("keydown",window.util.escapePressHandler)},s=e=>{let t=window.filter.getfilteredDataArray(e),n=window.filter.MAX_SIMILAR_PINS_COUNT;t.length<window.filter.MAX_SIMILAR_PINS_COUNT&&(n=t.length),t=t.slice(0,n),t.forEach((e=>{const t=window.pins.renderElement(e);r.appendChild(t),t.addEventListener("click",(()=>{c(e)})),t.addEventListener("keydown",(t=>{window.util.Keys.isEnter(t)&&c(e)}))})),o.appendChild(r)},d=t=>{e=t;const o=t.length>window.filter.MAX_SIMILAR_PINS_COUNT?t.slice(0,window.filter.MAX_SIMILAR_PINS_COUNT):t;s(o)},l=e=>{const t=document.createElement("div");t.style="z-index: 100; color: wheat;",t.style.fontSize="30px",t.classList.add("error"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},a=()=>{const e=t.querySelector(".popup");e&&t.removeChild(e)},u=()=>{document.removeEventListener("keydown",window.util.escapePressHandler),t.querySelector(".popup__close").removeEventListener("click",window.util.buttonClickHandler),a()};i.addEventListener("change",(()=>{window.util.debounce((()=>{s(e)})),window.form.removePins(),a()})),window.page={showPins:()=>{window.load(d,l)},removeCard:a,dataArray:e,successHandler:d,updatePins:s,closePopup:u}})(),(()=>{const e={house:{name:"дом",minprice:5e3},flat:{name:"квартира",minprice:1e3},palace:{name:"дворец",minprice:1e4},bungalow:{name:"бунгало",minprice:0}},t={1:[1],2:[1,2],3:[1,2,3],100:[0]},o=document.querySelector(".map"),r=o.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),i=document.querySelector(".map__filters-container"),c=n.querySelectorAll("fieldset"),s=i.querySelectorAll("select"),d=i.querySelectorAll(".map__checkbox"),l=n.querySelector("#price"),a=n.querySelector("#type"),u=n.querySelector("#timeout"),p=n.querySelector("#timein"),m=n.querySelector("#room_number"),f=n.querySelector("#capacity"),y=n.querySelector(".ad-form__reset"),w=n.querySelector(".ad-form__field input[type=file]"),v=n.querySelector(".ad-form-header__preview img"),h=v.src,_=n.querySelector(".ad-form__upload input[type=file]"),S=n.querySelector(".ad-form__photo"),E=()=>{window.util.chooseFile(w,v)},q=()=>{window.util.chooseFile(_,S,!1)},g={y:r.offsetTop,x:r.offsetLeft};window.move.fillAddressValue(g.x,g.y,!1),l.placeholder=e[a.value].minprice,l.min=e[a.value].minprice;const L=(e,t)=>{t.value=e.value},k=()=>{f.value=t[m.value][0],f.querySelectorAll("option").forEach((e=>{e.disabled=!t[m.value].includes(Number(e.value))}))};f.value=t[m.value][0],k();const x=()=>{o.querySelectorAll(".map__pin:not(:first-of-type)").forEach((e=>{e.remove()}))},A=()=>{o.classList.add("map--faded"),n.classList.add("ad-form--disabled"),f.value=t[m.value][0],k(),window.move.fillAddressValue(g.x,g.y,!1),r.style.left=g.x+"px",r.style.top=g.y+"px",c.forEach((e=>{e.disabled=!0})),s.forEach((e=>{e.disabled=!0,e.selectedIndex=0})),d.forEach((e=>{e.checked=!1,e.disabled=!0})),x(),document.querySelector(".popup")&&window.page.closePopup(),w.removeEventListener("change",E),_.removeEventListener("change",q),S.innerHTML="",v.src=h},b=()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);document.body.insertAdjacentElement("afterbegin",e);const t=document.querySelector(".error"),o=e=>{window.util.removeElement(e,t,o)};document.addEventListener("keydown",o),t.addEventListener("click",o)},H=()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);n.reset(),A(),x(),document.body.insertAdjacentElement("afterbegin",e);const t=document.querySelector(".success"),o=e=>{window.util.removeElement(e,t,o)};document.addEventListener("keydown",o),t.addEventListener("click",o)};a.addEventListener("input",(()=>{l.min=e[a.value].minprice,l.placeholder=e[a.value].minprice})),p.addEventListener("input",(()=>{L(p,u)})),u.addEventListener("input",(()=>{L(u,p)})),m.addEventListener("input",(()=>{k()})),window.form={TYPES:e,formActivateHandler:e=>{(0===e.button||window.page.Keys.isEnter(e))&&(r.style=`left: ${g.x}px; top: ${g.y-window.move.PIN_TAIL-r.offsetHeight/2}px;`,o.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),c.forEach((e=>{e.disabled=!1})),s.forEach((e=>{e.disabled=!1})),d.forEach((e=>{e.disabled=!1})),window.page.showPins(),n.addEventListener("submit",(e=>{window.load(H,b,new FormData(n)),e.preventDefault()})),w.addEventListener("change",E),_.addEventListener("change",q),y.addEventListener("click",A),r.removeEventListener("mousedown",window.form.formActivateHandler),r.removeEventListener("keydown",window.form.formActivateHandler))},formDeactivateHandler:A,removePins:x}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pin--main");window.form.formDeactivateHandler(),e.addEventListener("mousedown",window.form.formActivateHandler),e.addEventListener("keydown",window.form.formActivateHandler)})()})();